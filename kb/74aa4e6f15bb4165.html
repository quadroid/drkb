<!DOCTYPE html>
<html>
<head>
  <title>Как сделать экспорт TDataSet в XML-файл?</title>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
  <link type="text/css" href="css/css.css" rel="stylesheet"/>
  <link type="text/css" href="css/sh.css" rel="stylesheet"/>
  <script language="javascript" src="js/shInit.js"></script>
  <script language="javascript" src="js/shCore.js"></script>
  <script language="javascript" src="js/shBrushDelphi.js"></script>
  <script language="javascript" src="js/shBrushSql.js"></script>
</head>
<body>
<div id="layout">
<div id="header">
  <a title="DRKB Library" href="../splash.html"><div id="logo"></div></a>
</div>
<div id="content">
<div id="explorer">DRKB Explorer</div>
  <h1 id="title">Как сделать экспорт TDataSet в XML-файл?</h1>
<div id="date">01.01.2010</div>

<pre name="code" class="delphi">
{Unit to export a dataset to XML} 
 
unit DS2XML; 
 
interface 
 
uses 
  Classes, DB; 
 
procedure DatasetToXML(Dataset: TDataSet; FileName: string); 
 
implementation 
 
uses 
  SysUtils; 
 
var 
  SourceBuffer: PChar; 
 
procedure WriteString(Stream: TFileStream; s: string); 
begin 
  StrPCopy(SourceBuffer, s); 
  Stream.Write(SourceBuffer[0], StrLen(SourceBuffer)); 
end; 
 
procedure WriteFileBegin(Stream: TFileStream; Dataset: TDataSet); 
 
  function XMLFieldType(fld: TField): string; 
  begin 
    case fld.DataType of 
      ftString: Result   := '"string" WIDTH="' + IntToStr(fld.Size) + '"'; 
      ftSmallint: Result := '"i4"'; //?? 
      ftInteger: Result  := '"i4"'; 
      ftWord: Result     := '"i4"'; //?? 
      ftBoolean: Result  := '"boolean"'; 
      ftAutoInc: Result  := '"i4" SUBTYPE="Autoinc"'; 
      ftFloat: Result    := '"r8"'; 
      ftCurrency: Result := '"r8" SUBTYPE="Money"'; 
      ftBCD: Result      := '"r8"'; //?? 
      ftDate: Result     := '"date"'; 
      ftTime: Result     := '"time"'; //?? 
      ftDateTime: Result := '"datetime"'; 
      else 
    end; 
    if fld.Required then 
      Result := Result + ' required="true"'; 
    if fld.ReadOnly then 
      Result := Result + ' readonly="true"'; 
  end; 
var 
  i: Integer; 
begin 
  WriteString(Stream, '&lt;?xml version="1.0" standalone="yes"?&gt;&lt;!-- Generated by SMExport --&gt;  ' + 
    '&lt;DATAPACKET Version="2.0"&gt;'); 
  WriteString(Stream, '&lt;METADATA&gt;&lt;FIELDS&gt;'); 
 
  {write th metadata} 
  with Dataset do 
    for i := 0 to FieldCount - 1 do 
    begin 
      WriteString(Stream, '&lt;FIELD attrname="' + 
        Fields[i].FieldName + 
        '" fieldtype=' + 
        XMLFieldType(Fields[i]) + 
        '/&gt;'); 
    end; 
  WriteString(Stream, '&lt;/FIELDS&gt;'); 
  WriteString(Stream, '&lt;PARAMS DEFAULT_ORDER="1" PRIMARY_KEY="1" LCID="1033"/&gt;'); 
  WriteString(Stream, '&lt;/METADATA&gt;&lt;ROWDATA&gt;'); 
end; 
 
procedure WriteFileEnd(Stream: TFileStream); 
begin 
  WriteString(Stream, '&lt;/ROWDATA&gt;&lt;/DATAPACKET&gt;'); 
end; 
 
procedure WriteRowStart(Stream: TFileStream; IsAddedTitle: Boolean); 
begin 
  if not IsAddedTitle then 
    WriteString(Stream, '&lt;ROW'); 
end; 
 
procedure WriteRowEnd(Stream: TFileStream; IsAddedTitle: Boolean); 
begin 
  if not IsAddedTitle then 
    WriteString(Stream, '/&gt;'); 
end; 
 
procedure WriteData(Stream: TFileStream; fld: TField; AString: ShortString); 
begin 
  if Assigned(fld) and (AString &lt;&gt; '') then 
    WriteString(Stream, ' ' + fld.FieldName + '="' + AString + '"'); 
end; 
 
function GetFieldStr(Field: TField): string; 
 
  function GetDig(i, j: Word): string; 
  begin 
    Result := IntToStr(i); 
    while (Length(Result) &lt; j) do 
      Result := '0' + Result; 
  end; 
var  
  Hour, Min, Sec, MSec: Word; 
begin 
  case Field.DataType of 
    ftBoolean: Result := UpperCase(Field.AsString); 
    ftDate: Result    := FormatDateTime('yyyymmdd', Field.AsDateTime); 
    ftTime: Result    := FormatDateTime('hhnnss', Field.AsDateTime); 
    ftDateTime:  
      begin 
        Result := FormatDateTime('yyyymmdd', Field.AsDateTime); 
        DecodeTime(Field.AsDateTime, Hour, Min, Sec, MSec); 
        if (Hour &lt;&gt; 0) or (Min &lt;&gt; 0) or (Sec &lt;&gt; 0) or (MSec &lt;&gt; 0) then 
          Result := Result + 'T' + GetDig(Hour, 2) + ':' + GetDig(Min, 
            2) + ':' + GetDig(Sec, 2) + GetDig(MSec, 3); 
      end; 
    else 
      Result := Field.AsString; 
  end; 
end; 
 
procedure DatasetToXML(Dataset: TDataSet; FileName: string); 
var 
  Stream: TFileStream; 
  bkmark: TBookmark; 
  i: Integer; 
begin 
  Stream       := TFileStream.Create(FileName, fmCreate); 
  SourceBuffer := StrAlloc(1024); 
  WriteFileBegin(Stream, Dataset); 
 
  with DataSet do 
  begin 
    DisableControls; 
    bkmark := GetBookmark; 
    First; 
 
    {write a title row} 
    WriteRowStart(Stream, True); 
    for i := 0 to FieldCount - 1 do 
      WriteData(Stream, nil, Fields[i].DisplayLabel); 
    {write the end of row} 
    WriteRowEnd(Stream, True); 
 
    while (not EOF) do 
    begin 
      WriteRowStart(Stream, False); 
      for i := 0 to FieldCount - 1 do 
        WriteData(Stream, Fields[i], GetFieldStr(Fields[i])); 
      {write the end of row} 
      WriteRowEnd(Stream, False); 
 
      Next; 
    end; 
 
    GotoBookmark(bkmark); 
    EnableControls; 
  end; 
 
  WriteFileEnd(Stream); 
  Stream.Free; 
  StrDispose(SourceBuffer); 
end; 
 
end. 
</pre>

<pre name="code" class="delphi">
//Beispiel, Example: 
 
 
uses DS2XML; 
 
procedure TForm1.Button1Click(Sender: TObject); 
  begin  DatasetToXML(Table1, 'test.xml'); 
  end;
</pre>

<p>Взято с сайта <a href="http://www.swissdelphicenter.ch/en/tipsindex.php" target="_blank">http://www.swissdelphicenter.ch/en/tipsindex.php</a></p>
</div>

<div id="footer">
<hr/>
<p>Материал из DRKB Library<br/>Разработка и поддержка &mdash; <a title="DRKB на GitHub" href="https://github.com/quadroid/drkb" target="_blank">Quadr0</a></p>
</div>
</div>
</body>
</html>
